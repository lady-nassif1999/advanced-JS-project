<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Media Platform</title>

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<!-- Axios -->
<script src="./node_modules/axios/dist/axios.min.js"></script>
<script src="./node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="./mainLogic.js"></script>

<style>
  body { background-color: rgba(250, 235, 215, 0.623); }

  #addpost { position: fixed; bottom: 5%; left: 9%; z-index: 1000; cursor: pointer; }
  #cards .card { margin-bottom: 2rem; }
  .card-header img { margin-right: 10px; }
  .card-body hr { margin: 10px 0; }
  /* .card {
    max-height: 50%;
    overflow: hidden;
    border-radius: 10px;
  }
  .card img {
    height: 200px;
    width: 100%;
    object-fit: cover;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    margin-top: 10px;
  } */
</style>
</head>
<body>

<!-- ALERT PLACEHOLDER -->
<div id="liveAlertPlaceholder" class="position-fixed bottom-0 end-0 p-3" style="z-index: 222;"></div>

<!-- ADD POST BUTTON -->
<div id="addpost" data-bs-toggle="modal" data-bs-target="#addPostModal">
  <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="blue" class="bi bi-plus-circle" viewBox="0 0 16 16">
    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
  </svg>
</div>

<nav class="container col-8 navbar navbar-expand-lg navbar-light bg-light shadow-sm mb-4">
  <div class="container col-8">
    <a class="navbar-brand" href="#">LADY</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <div class="navbar-nav me-auto">
        <a class="nav-link active" href="home.html">Home</a>
        <a class="nav-link" href="#">Profile</a>
      </div>
      <div class="d-flex align-items-center">
        <img id="userProfile" src="imgs/download.png" alt="Profile" class="rounded-circle" style="width:30px; height:30px; display:none;">
        <span id="navUserName" class="ms-2 text-primary" style="display:none;"></span>
        <button id="loginBtn" type="button" class="btn btn-outline-primary ms-3" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
        <button id="registerBtn" type="button" class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#registerModal">Register</button>
        <button id="logoutBtn" type="button" class="btn btn-outline-danger ms-2" style="display:none;" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>
</nav>

<!-- USER POST CARD -->
<div class="mb-4 container col-8">
  <div class="row d-flex justify-content-center mt-5 ">
    <div class="col-lg-9">
      <h1><span id="username-span"></span></h1>
    </div>
  </div>

  <div class="row d-flex justify-content-center mt-5">
    <div class="card" id="post-user">
      <!-- محتوى البوست والتعليقات سيُضاف ديناميكياً -->
    </div>
  </div>
</div>

  <!-- ================= MODALS ================= -->
  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" class="form-control mb-2" id="username-input" placeholder="Username">
          <input type="password" class="form-control" id="password-input" placeholder="Password">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" onclick="loginForm()">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Register</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="file" class="form-control mb-2" id="image-input-register">
          <input type="text" class="form-control mb-2" id="username-input-register" placeholder="Username">
          <input type="text" class="form-control mb-2" id="name-input-register" placeholder="Full Name">
          <input type="password" class="form-control" id="password-input-register" placeholder="Password">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" onclick="registerForm()">Register</button>
        </div>
      </div>
    </div>
  </div>

<script>
setUpUi();
const baseUrl = "https://tarmeezacademy.com/api/v1";
const urlParams = new URLSearchParams(window.location.search)
const id = urlParams.get("id");

getPost();

function getPost() {
  axios.get(`${baseUrl}/posts/${id}`)
    .then((response) => {
      const post = response.data.data;
      const author = post.author;
      const comments = post.comments;

      // ===== صورة البروفايل للبوست =====
      const postProfileImage = author && author.profile_image && typeof author.profile_image === 'string'
        ? (author.profile_image.startsWith('http') 
            ? author.profile_image 
            : `${baseUrl}${author.profile_image}`)
        : 'imgs/download.png';

      // ===== صورة البوست نفسه =====
      const postMainImage = post.image && typeof post.image === 'string' && post.image.trim() !== ''
        ? post.image
        : 'imgs/download.png';

      // ===== بناء التعليقات =====
      let commentContent = '';
      for (let comment of comments) {
        const commentAuthor = comment.author;

        // صورة البروفايل للتعليق
        const commentProfileImage = commentAuthor && commentAuthor.profile_image && typeof commentAuthor.profile_image === 'string'
          ? (commentAuthor.profile_image.startsWith('http') 
              ? commentAuthor.profile_image 
              : `${baseUrl}${commentAuthor.profile_image}`)
          : 'imgs/download.png';

        commentContent += `
          <div class="p-3 mb-2" style="background-color: beige;">
            <div class="d-flex align-items-center mb-1">
              <img src="${commentProfileImage}" class="rounded-circle me-2" style="width:30px;height:30px;" 
                   onerror="this.src='imgs/download.png'">
              <b>${commentAuthor.username}</b>
            </div>
            <div style="padding-left:40px">${comment.body}</div>
          </div>
        `;
      }

      // ===== بناء HTML البوست بالكامل =====
      const cardData = `
        <div class="card row d-flex justify-content-center mb-4">
          <div class="card-header d-flex align-items-center">
            <img src="${postProfileImage}" class="rounded-circle me-2" style="width:30px;height:30px;" 
                 onerror="this.src='imgs/download.png'">
            ${author.username}
          </div>
          <div>
            <img src="${postMainImage}" class="container mb-2" onerror="this.src='imgs/download.png'">
          </div>
          <span class="ms-2 text-muted">${post.created_at}</span>
          <div class="card-body">
            <h5 class="card-title">${post.title || ''}</h5>
            <p class="card-text">${post.body}</p>
            <hr>
            <i class="bi bi-pen"></i> <span>${post.comments_count}</span>
            <span>${post.tags}</span>
          </div>
        </div>

        <div id="comment">
          ${commentContent}
        </div>

        <div class="input-group mb-3" id="add-comment-div">
          <input id="comment-input" type="text" placeholder="Add your comment here ..." class="form-control">
          <button class="btn btn-outline-primary" type="button" onclick="createCommentInput()">Send</button>
        </div>
      `;

      document.getElementById("post-user").innerHTML = cardData;
      document.getElementById("username-span").innerHTML = author.username;
    })
    .catch((error) => {
      console.error("Error fetching post:", error);
    });
}

function createCommentInput() {
  const commentBody = document.getElementById("comment-input").value;
  const token = localStorage.getItem("token");
  const url = `${baseUrl}/posts/${id}/comments`;
  const params = { body: commentBody };

  axios.post(url, params, {
    headers: { "Authorization": `Bearer ${token}` }
  })
  .then((response) => {
    console.log(response.data);
    getPost(); // إعادة تحميل البوست مع التعليقات
  })
  .catch((error) => {
    console.error("Error creating comment:", error);
  });
}
</script>
</body>
</html>
